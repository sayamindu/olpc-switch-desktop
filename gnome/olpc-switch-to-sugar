#!/usr/bin/env python

import sys
import os
import os.path
import subprocess

import pygtk
pygtk.require('2.0')
import gtk

def do_switch():
	try:
		fd = open(os.path.join(os.environ['HOME'], ".olpc-active-desktop"), "w")
		fd.write("sugar")
		fd.close()
	except Exception, e:
		print "Error:", e
		dlg = gtk.MessageDialog(type=gtk.MESSAGE_ERROR, buttons=gtk.BUTTONS_OK,
			message_format="Could not switch desktop: an internal error has "
			"occurred.")
		dlg.run()
		dlg.destroy()
		return
	subprocess.call(['dbus-send','--session','--dest=org.gnome.SessionManager',
		'/org/gnome/SessionManager','org.gnome.SessionManager.Logout',
		'uint32:1'])

def main():
	dlg = gtk.MessageDialog(parent=None, type=gtk.MESSAGE_INFO,
		buttons=gtk.BUTTONS_OK_CANCEL,
		message_format="Click OK to switch to the Sugar learning "
		"environment.\nAll active applications will be closed.")
	dlg.set_title("Switch desktop")
	dlg.set_property("skip-taskbar-hint", False)

	icon_theme = gtk.icon_theme_get_default()
	pixbuf = icon_theme.load_icon("olpc-switch-to-sugar", 48, 0)
	dlg.set_icon(pixbuf)

	resp = dlg.run()
	dlg.destroy()
	if resp == gtk.RESPONSE_OK:
		do_switch()

if __name__ == "__main__":
	main()
